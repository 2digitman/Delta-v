using Content.Shared.Disease;
using Content.Shared.Materials;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Client.UserInterface.Controls;
using Robust.Shared.Prototypes;

namespace Content.Client.Disease.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class VaccineMachineMenu : DefaultWindow
    {

        [Dependency] private readonly IEntityManager _entityManager = default!;

        private readonly SharedMaterialStorageSystem _storage;

        public VaccineMachineBoundUserInterface Owner { get; }

        public event Action<BaseButton.ButtonEventArgs>? OnServerSelectionButtonPressed;

        private readonly List<DiseasePrototype> _knownDiseasePrototypes = new();

        public DiseasePrototype? DiseaseSelected;
        public bool Enough = false;

        public VaccineMachineMenu(VaccineMachineBoundUserInterface owner)
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);
            _storage = _entityManager.EntitySysManager.GetEntitySystem<SharedMaterialStorageSystem>();

            Owner = owner;

            ServerSelectionButton.OnPressed += a => OnServerSelectionButtonPressed?.Invoke(a);

            KnownDiseases.OnItemSelected += KnownDiseaseSelected;
            CreateButton.OnPressed += _ =>
            {
                CreateVaccine();
            };

            Populate();
        }

        /// <summary>
        ///     Called when a known disease is selected.
        /// </summary>
        private void KnownDiseaseSelected(ItemList.ItemListSelectedEventArgs obj)
        {
            DiseaseSelected = _knownDiseasePrototypes[obj.ItemIndex];
            CreateButton.Disabled = !Enough;

            PopulateSelectedDisease();
        }

        /// <summary>
        ///     Sends a message to create a vaccine from the selected technology.
        /// </summary>
        private void CreateVaccine()
        {
            if (DiseaseSelected == null)
                return;

            Owner.CreateVaccineMessage(DiseaseSelected);
        }

        /// <summary>
        ///     Updates the whole user interface.
        /// </summary>
        public void Populate()
        {
            PopulateDiseases();
        }

        public void PopulateDiseases()
        {
            KnownDiseases.Clear();

            _knownDiseasePrototypes.Clear();

            var prototypeMan = IoCManager.Resolve<IPrototypeManager>();

            foreach (var disease in prototypeMan.EnumeratePrototypes<DiseasePrototype>())
            {
                if (!disease.Infectious)
                    continue;

                KnownDiseases.AddItem(disease.Name);
                _knownDiseasePrototypes.Add(disease);
            }
        }

        public void PopulateSelectedDisease()
        {
            if (DiseaseSelected == null)
            {
                CreateButton.Disabled = true;
                DiseaseName.Text = Loc.GetString("vaccine-machine-menu-none-selected");
                DiseaseResistance.Text = Loc.GetString("vaccine-machine-menu-spaceacillin-resist-none");
                return;
            }

            DiseaseName.Text = DiseaseSelected.Name;
            DiseaseResistance.Text = Loc.GetString("vaccine-machine-menu-spaceacillin-resist", ("value", DiseaseSelected.CureResist.ToString()));
        }

        public void PopulateBiomass(EntityUid machine)
        {
            var amt = _storage.GetMaterialAmount(machine, "Biomass");
            Enough = (amt > 4);
            BiomassCurrent.Text = Loc.GetString("vaccine-machine-menu-biomass-current", ("value", amt));

            if (DiseaseSelected != null)
                CreateButton.Disabled = !Enough;
        }
    }
}
